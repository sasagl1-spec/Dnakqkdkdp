from .. import loader, utils
import logging
import asyncio
import re
from typing import List

logger = logging.getLogger(__name__)

@loader.tds
class AutoReactionsMod(loader.Module):
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∞–∫—Ü–∏–π –Ω–∞ –∫–∞–∂–¥–æ–µ 40-–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    strings = {
        "name": "AutoReactions40",
        "status_enabled": "‚úÖ –ê–≤—Ç–æ—Ä–µ–∞–∫—Ü–∏–∏ –≤–∫–ª—é—á–µ–Ω—ã –¥–ª—è —á–∞—Ç–∞ {}",
        "status_disabled": "‚ùå –ê–≤—Ç–æ—Ä–µ–∞–∫—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã –¥–ª—è —á–∞—Ç–∞ {}",
        "already_enabled": "‚ö†Ô∏è –ê–≤—Ç–æ—Ä–µ–∞–∫—Ü–∏–∏ —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞",
        "already_disabled": "‚ö†Ô∏è –ê–≤—Ç–æ—Ä–µ–∞–∫—Ü–∏–∏ —É–∂–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞",
        "not_in_chat": "‚ö†Ô∏è –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —á–∞—Ç–∞—Ö",
        "stats": "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —á–∞—Ç–∞–º:\n{}",
        "no_stats": "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",
        "invalid_reaction": "‚ùå –ù–µ–¥–æ–ø—É—Å—Ç–∏–º–∞—è —Ä–µ–∞–∫—Ü–∏—è: {}",
        "emoji_only": "‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —ç–º–æ–¥–∑–∏-—Ä–µ–∞–∫—Ü–∏–∏"
    }

    def __init__(self):
        self.message_count = {}
        self.enabled_chats = set()
        self.reactions = self._filter_emoji(['ü•µ', 'ü•∞', '‚ù§Ô∏è'])
        self.config = loader.ModuleConfig(
            "REACTION_INTERVAL", 40, "–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π"
        )

    def _filter_emoji(self, reactions: List[str]) -> List[str]:
        """–§–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ —ç–º–æ–¥–∑–∏-—Ä–µ–∞–∫—Ü–∏–∏"""
        valid_emoji = []
        for reaction in reactions:
            if self._is_valid_emoji(reaction):
                valid_emoji.append(reaction)
            else:
                logger.warning(f"Invalid reaction removed: {reaction}")
        
        return valid_emoji

    def _is_valid_emoji(self, text: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –≤–∞–ª–∏–¥–Ω—ã–º —ç–º–æ–¥–∑–∏"""
        # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —ç–º–æ–¥–∑–∏ (Unicode –¥–∏–∞–ø–∞–∑–æ–Ω—ã)
        emoji_ranges = [
            (0x1F600, 0x1F64F),  # Emoticons
            (0x1F300, 0x1F5FF),  # Miscellaneous Symbols and Pictographs
            (0x1F680, 0x1F6FF),  # Transport and Map Symbols
            (0x1F700, 0x1F77F),  # Alchemical Symbols
            (0x1F780, 0x1F7FF),  # Geometric Shapes Extended
            (0x1F800, 0x1F8FF),  # Supplemental Arrows-C
            (0x1F900, 0x1F9FF),  # Supplemental Symbols and Pictographs
            (0x1FA00, 0x1FA6F),  # Chess Symbols
            (0x1FA70, 0x1FAFF),  # Symbols and Pictographs Extended-A
            (0x02700, 0x027BF),  # Dingbats
            (0x024C2, 0x1F251),  # Enclosed characters
            (0x1F004, 0x1F0CF),  # Playing Cards
            (0x1F170, 0x1F251)   # Enclosed Alphanumeric Supplement
        ]
        
        for char in text:
            code_point = ord(char)
            is_emoji = any(start <= code_point <= end for start, end in emoji_ranges)
            if not is_emoji:
                return False
        return True

    async def client_ready(self, client, db):
        self._client = client

    @loader.watcher(only_messages=True)
    async def watcher(self, message):
        """–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏"""
        try:
            chat_id = utils.get_chat_id(message)
            if not chat_id or chat_id not in self.enabled_chats:
                return

            if chat_id not in self.message_count:
                self.message_count[chat_id] = 0
            
            self.message_count[chat_id] += 1

            if self.message_count[chat_id] % self.config["REACTION_INTERVAL"] == 0:
                for reaction in self.reactions:
                    try:
                        await message.react(reaction)
                        await asyncio.sleep(0.3)
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ —Ä–µ–∞–∫—Ü–∏–∏ {reaction}: {e}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ watcher: {e}")

    async def arstart_cmd(self, message):
        """–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—Ä–µ–∞–∫—Ü–∏–∏ –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ"""
        chat_id = utils.get_chat_id(message)
        if not chat_id:
            return await utils.answer(message, self.strings["not_in_chat"])
        
        if chat_id in self.enabled_chats:
            return await utils.answer(message, self.strings["already_enabled"])
        
        self.enabled_chats.add(chat_id)
        await utils.answer(message, self.strings["status_enabled"].format(chat_id))

    async def arstop_cmd(self, message):
        """–í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—Ä–µ–∞–∫—Ü–∏–∏ –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ"""
        chat_id = utils.get_chat_id(message)
        if not chat_id:
            return await utils.answer(message, self.strings["not_in_chat"])
        
        if chat_id not in self.enabled_chats:
            return await utils.answer(message, self.strings["already_disabled"])
        
        self.enabled_chats.remove(chat_id)
        await utils.answer(message, self.strings["status_disabled"].format(chat_id))

    async def arstats_cmd(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —á–∞—Ç–∞–º"""
        if not self.message_count:
            return await utils.answer(message, self.strings["no_stats"])
        
        stats_text = []
        for chat_id, count in self.message_count.items():
            status = "‚úÖ" if chat_id in self.enabled_chats else "‚ùå"
            stats_text.append(f"{status} –ß–∞—Ç {chat_id}: {count} —Å–æ–æ–±—â–µ–Ω–∏–π")
        
        await utils.answer(message, self.strings["stats"].format("\n".join(stats_text)))

    async def arreset_cmd(self, message):
        """–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        self.message_count.clear()
        await utils.answer(message, "‚úÖ –°—á–µ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–±—Ä–æ—à–µ–Ω—ã")

    async def arsetinterval_cmd(self, message):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: .arsetinterval <—á–∏—Å–ª–æ>"""
        args = utils.get_args_raw(message)
        if not args.isdigit():
            return await utils.answer(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ")
        
        new_interval = int(args)
        if new_interval < 1:
            return await utils.answer(message, "‚ùå –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0")
        
        self.config["REACTION_INTERVAL"] = new_interval
        await utils.answer(message, f"‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {new_interval} —Å–æ–æ–±—â–µ–Ω–∏–π")

    async def arsetreactions_cmd(self, message):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ä–µ–∞–∫—Ü–∏–∏: .arsetreactions üòÇ ü•∫ üëç"""
        args = utils.get_args_raw(message)
        if not args:
            return await utils.answer(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ —ç–º–æ–¥–∑–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª")
        
        new_reactions = args.split()
        filtered_reactions = self._filter_emoji(new_reactions)
        
        if not filtered_reactions:
            return await utils.answer(message, "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —ç–º–æ–¥–∑–∏")
        
        self.reactions = filtered_reactions
        await utils.answer(message, 
            f"‚úÖ –†–µ–∞–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: {''.join(filtered_reactions)}\n"
            f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {len(filtered_reactions)}"
        )

    async def arlist_cmd(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ —Ä–µ–∞–∫—Ü–∏–∏"""
        await utils.answer(message, 
            f"üìã –¢–µ–∫—É—â–∏–µ —Ä–µ–∞–∫—Ü–∏–∏:\n{''.join(self.reactions)}\n"
            f"–í—Å–µ–≥–æ: {len(self.reactions)} —ç–º–æ–¥–∑–∏"
        )        """–í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—Ä–µ–∞–∫—Ü–∏–∏ –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ"""
        chat_id = utils.get_chat_id(message)
        if not chat_id:
            return await utils.answer(message, self.strings["not_in_chat"])
        
        if chat_id not in self.enabled_chats:
            return await utils.answer(message, self.strings["already_disabled"])
        
        self.enabled_chats.remove(chat_id)
        await utils.answer(message, self.strings["status_disabled"].format(chat_id))

    async def arstats_cmd(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —á–∞—Ç–∞–º"""
        if not self.message_count:
            return await utils.answer(message, self.strings["no_stats"])
        
        stats_text = []
        for chat_id, count in self.message_count.items():
            status = "‚úÖ" if chat_id in self.enabled_chats else "‚ùå"
            stats_text.append(f"{status} –ß–∞—Ç {chat_id}: {count} —Å–æ–æ–±—â–µ–Ω–∏–π")
        
        await utils.answer(message, self.strings["stats"].format("\n".join(stats_text)))

    async def arreset_cmd(self, message):
        """–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        self.message_count.clear()
        await utils.answer(message, "‚úÖ –°—á–µ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–±—Ä–æ—à–µ–Ω—ã")

    async def arsetinterval_cmd(self, message):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: .arsetinterval <—á–∏—Å–ª–æ>"""
        args = utils.get_args_raw(message)
        if not args.isdigit():
            return await utils.answer(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ")
        
        new_interval = int(args)
        if new_interval < 1:
            return await utils.answer(message, "‚ùå –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0")
        
        self.config["REACTION_INTERVAL"] = new_interval
        await utils.answer(message, f"‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {new_interval} —Å–æ–æ–±—â–µ–Ω–∏–π")

    async def arsetreactions_cmd(self, message):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ä–µ–∞–∫—Ü–∏–∏: .arsetreactions üòÇ ü•∫ üëç"""
        args = utils.get_args_raw(message)
        if not args:
            return await utils.answer(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ —ç–º–æ–¥–∑–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª")
        
        new_reactions = args.split()
        filtered_reactions = self._filter_emoji(new_reactions)
        
        if not filtered_reactions:
            return await utils.answer(message, "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —ç–º–æ–¥–∑–∏")
        
        self.reactions = filtered_reactions
        await utils.answer(message, 
            f"‚úÖ –†–µ–∞–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: {''.join(filtered_reactions)}\n"
            f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {len(filtered_reactions)}"
        )
